# 機能一覧

本アプリケーションが提供する3つの主要機能とCI/CDパイプラインの詳細を説明します。

## 機能概要

| 機能名 | 目的 | 入力項目 | 出力結果 |
|--------|------|----------|----------|
| 姓名判断 | 特定の名前の運勢を判定 | 姓・名・性別 | 五格の運勢スコア |
| 画数パターン分析 | 最適な画数組み合わせを発見 | 姓・文字数 | 最適パターン上位20件 |
| 名前候補生成 | 画数条件に合う名前を検索 | 画数・性別 | 候補名前リスト（最大50件） |

## 開発運用機能

| 機能名 | 目的 | トリガー | 出力結果 |
|--------|------|----------|----------|
| CI/CDパイプライン | コード品質保証・自動デプロイ | Push/PR | テスト結果・セキュリティレポート |
| セキュリティスキャン | 脆弱性検出・静的解析 | Push/PR | SARIF形式セキュリティレポート |

## 1. 姓名判断機能

### 📋 概要
入力された姓名から五格（天格・人格・地格・外格・総格）を計算し、2つの姓名判断サイトの結果を統合して運勢スコアを算出します。

### 🔄 処理フロー
```mermaid
graph TD
    A[姓・名・性別を入力] --> B[画数計算]
    B --> C[五格算出]
    C --> D[enamae.net]
    C --> E[namaeuranai.biz]
    D --> F[結果統合・スコア計算]
    E --> F
    F --> G[診断結果表示]
```

### 💯 スコア計算基準
**enamae.net**
- 大吉：100点 | 特殊格：90点 | 吉：80点 | 吉凶混合：60点 | 凶：40点 | 大凶：20点

**namaeuranai.biz**
- 大大吉：100点 | 大吉：90点 | 吉：80点 | 凶：40点 | 大凶：20点

**総合スコア = (enamae平均点 + namaeuranai平均点) ÷ 2**

## 2. 画数パターン分析機能

### 📋 概要
指定した文字数（1〜3文字）の全画数パターン（1〜20画）を網羅的に分析し、運勢スコアの高い組み合わせを発見します。

### 🔄 処理フロー
```mermaid
graph TD
    A[姓・文字数を入力] --> B[パターン生成]
    B --> C[並列分析実行]
    C --> D[進捗リアルタイム表示]
    C --> E[各パターンの運勢判定]
    E --> F[スコア計算・ソート]
    F --> G[上位20件をJSON保存]
    G --> H[結果表示]
```

### ⏱️ 処理時間の目安
- 1文字：約30秒（20パターン）
- 2文字：約5分（400パターン）
- 3文字：約17分（8,000パターン）

### 📊 出力形式
- リアルタイム進捗表示
- JSON形式での結果保存（`static/results_姓_文字数字.json`）
- 運勢スコア順での上位20件表示

## 3. 名前候補生成機能

### 📋 概要
指定した画数・文字数・性別の条件に合致する実在の名前候補を検索します。データは「赤ちゃん命名ガイド」から収集されたものを使用します。

### 🔄 処理フロー
```mermaid
graph TD
    A[画数・文字数・性別を入力] --> B{データベース検索}
    B -->|データあり| C[即座に候補表示]
    B -->|データなし| D[バックグラウンドスクレイピング開始]
    D --> E[赤ちゃん命名ガイドから情報取得]
    E --> F[SQLiteデータベースに保存]
    F --> G[候補検索・表示]
```

### 📋 入力条件
- **文字数**: 1〜3文字
- **画数**: 各文字の画数（1〜20画）
- **性別**: 男性・女性・指定なし

### 📊 出力結果
- 条件に合致する名前候補（漢字・読み・性別）
- 最大50件まで表示
- データがない場合は自動でスクレイピング実行

### ⚠️ 利用上の注意
- 初回検索時はスクレイピングにより時間がかかる場合があります
- データソースの利用規約を遵守し、適切な間隔でアクセスしています

## 4. CI/CDパイプライン機能

### 📋 概要
GitHub Actionsを使用した継続的インテグレーション・継続的デプロイメントパイプラインです。コード品質の維持とセキュリティチェックを自動化します。

### 🔄 パイプラインフロー
```mermaid
graph TD
    A[Git Push/PR] --> B[テストジョブ]
    A --> C[セキュリティスキャンジョブ]
    A --> D[Dockerビルドジョブ]

    B --> E[Python環境セットアップ]
    E --> F[依存関係インストール]
    F --> G[Pre-commitフック実行]
    G --> H[テストカバレッジ測定]
    H --> I[Codecovアップロード]

    C --> J[Trivyスキャン実行]
    J --> K[SARIF形式レポート生成]
    K --> L[GitHub Security tabにアップロード]

    D --> M[Docker Buildxセットアップ]
    M --> N[Dockerイメージビルド]
    N --> O[イメージテスト実行]

    B --> P{mainブランチ?}
    C --> P
    D --> P
    P -->|Yes| Q[デプロイジョブ]
    Q --> R[ステージング環境デプロイ]
```

### 🔧 実行されるチェック項目

#### コード品質チェック
- **Black**: コードフォーマット統一
- **isort**: インポート文の整理
- **flake8**: PEP8準拠チェック
- **mypy**: 型ヒント検証

#### テスト実行
- **pytest**: ユニットテスト・統合テスト
- **coverage**: テストカバレッジ測定
- **Redis**: インメモリデータベースのテスト

#### セキュリティチェック
- **Trivy**: 脆弱性スキャン（ファイルシステム）
- **GitHub Security**: SARIF形式でのレポート統合

### 📊 出力結果
- テストカバレッジレポート
- セキュリティ脆弱性レポート（GitHub Security tab）
- Dockerイメージビルド結果
- デプロイメントログ

## 5. セキュリティスキャン機能

### 📋 概要
Trivyを使用したファイルシステムレベルの脆弱性検出機能です。依存関係の既知の脆弱性を自動検出し、GitHub Securityタブで管理できます。

### 🔄 スキャンフロー
```mermaid
graph TD
    A[コードプッシュ] --> B[Trivyスキャン開始]
    B --> C[ファイルシステム解析]
    C --> D[依存関係脆弱性チェック]
    D --> E[SARIF形式レポート生成]
    E --> F[GitHub CodeQL Action]
    F --> G[Security Tabにアップロード]
    G --> H[アラート通知]
```

### 🛡️ 検出対象
- **Python依存関係**: requirements.txt、pyproject.toml
- **Docker依存関係**: Dockerfile、コンテナイメージ
- **設定ファイル**: セキュリティ設定の誤設定
- **シークレット**: ハードコードされた認証情報

### 📈 権限設定
パイプラインには以下の権限が設定されています：
- **actions: read** - Actionsの実行ログ読み取り
- **contents: read** - リポジトリコンテンツの読み取り
- **security-events: write** - セキュリティイベントの書き込み

### 🚨 アラート管理
- 脆弱性検出時は自動でGitHub Securityタブにアラート表示
- 重要度別（Critical、High、Medium、Low）での分類
- 修正提案の自動生成（Dependabot連携）
