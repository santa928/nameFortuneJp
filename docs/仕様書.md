# å§“ååˆ¤æ–­ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æŠ€è¡“ä»•æ§˜æ›¸

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ
```mermaid
graph TB
    subgraph "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤"
        UI[Web UI<br/>HTML/CSS/JS]
    end

    subgraph "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤"
        API[Flask API Server]
        VAL[Pydantic Validation]
        ERR[Error Handler]
        LOG[Structured Logging]
    end

    subgraph "ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤"
        FA[FortuneAnalyzer<br/>éåŒæœŸå‡¦ç†]
        NG[NameGenerator<br/>DBæ¤œç´¢]
        SC[AsyncScraper<br/>ä¸¦åˆ—å‡¦ç†]
    end

    subgraph "ãƒ‡ãƒ¼ã‚¿å±¤"
        DB[(SQLite DB<br/>åå‰å€™è£œ)]
        CACHE[JSON Files<br/>åˆ†æçµæœ]
        STATIC[Static Files<br/>çµæœå‡ºåŠ›]
    end

    subgraph "å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹"
        E1[enamae.net]
        E2[namaeuranai.biz]
        E3[b-name.jp]
    end

    UI --> API
    API --> VAL
    VAL --> FA
    VAL --> NG
    FA --> SC
    SC --> E1
    SC --> E2
    NG --> DB
    NG --> E3
    FA --> CACHE
    API --> STATIC
    API --> ERR
    API --> LOG
```

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°
| å±¤ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----|------|------------|------|
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | HTML5/CSS3/ES6 | Latest | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–UI |
| Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Flask | 2.3+ | è»½é‡APIå®Ÿè£… |
| è¨€èª | Python | 3.8+ | å‹ãƒ’ãƒ³ãƒˆå¯¾å¿œ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | Pydantic | 2.0+ | å‹å®‰å…¨æ€§ä¿è¨¼ |
| éåŒæœŸå‡¦ç† | asyncio | Built-in | I/Oé›†ç´„å‹æœ€é©åŒ– |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | SQLite | 3.35+ | è»½é‡ãƒ»çµ„ã¿è¾¼ã¿ |
| ãƒ­ã‚° | structlog | Latest | æ§‹é€ åŒ–ãƒ­ã‚° |
| ã‚³ãƒ³ãƒ†ãƒŠ | Docker/Compose | Latest | ç’°å¢ƒçµ±ä¸€ |

## ğŸ”§ æ©Ÿèƒ½åˆ¥æŠ€è¡“ä»•æ§˜

### å§“ååˆ¤æ–­æ©Ÿèƒ½
**å®Ÿè£…ã‚¯ãƒ©ã‚¹**: `FortuneAnalyzer`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /analyze`

**å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPydanticï¼‰**
```python
class FortuneRequest(BaseModel):
    last_name: str = Field(..., min_length=1, max_length=10)
    first_name: str = Field(..., min_length=1, max_length=10)
    gender: Literal['m', 'f'] = Field(..., description="æ€§åˆ¥")
```

**å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹**
```mermaid
sequenceDiagram
    participant UI as Web UI
    participant API as Flask API
    participant VAL as Pydantic
    participant SC as AsyncScraper
    participant E1 as enamae.net
    participant E2 as namaeuranai.biz

    UI->>API: POST /analyze
    API->>VAL: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    VAL->>SC: ä¸¦åˆ—ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
    par
        SC->>E1: é‹å‹¢å–å¾—
        SC->>E2: é‹å‹¢å–å¾—
    end
    E1-->>SC: çµæœ1
    E2-->>SC: çµæœ2
    SC->>SC: ã‚¹ã‚³ã‚¢çµ±åˆè¨ˆç®—
    SC-->>API: çµ±åˆçµæœ
    API-->>UI: JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿æ§‹é€ **
```json
{
  "enamae": {
    "å¤©æ ¼": "å¤§å‰", "äººæ ¼": "å‰", "åœ°æ ¼": "å¤§å‰",
    "å¤–æ ¼": "å‡¶", "ç·æ ¼": "å‰", "ä¸‰æ‰é…ç½®": "å‰"
  },
  "namaeuranai": {
    "å¤©æ ¼": "å¤§å¤§å‰", "äººæ ¼": "å‰", "åœ°æ ¼": "å¤§å‰",
    "å¤–æ ¼": "å‡¶", "ç·æ ¼": "å‰", "ä»•äº‹é‹": "å‰", "å®¶åº­é‹": "å‰"
  },
  "total_score": 87.5
}
```

### ç”»æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†ææ©Ÿèƒ½
**å®Ÿè£…ã‚¯ãƒ©ã‚¹**: `FortuneAnalyzer` + `StrokePatternGenerator`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /analyze_strokes`, `GET /analyze_progress/<queue_id>`

**éåŒæœŸå‡¦ç†è¨­è¨ˆ**
```python
async def analyze(self, last_name: str, char_count: int):
    # ã‚»ãƒãƒ•ã‚©ã§ä¸¦åˆ—æ•°åˆ¶å¾¡ï¼ˆæœ€å¤§4ä¸¦åˆ—ï¼‰
    semaphore = asyncio.Semaphore(4)

    async def process_pattern(pattern):
        async with semaphore:
            await asyncio.sleep(0.5)  # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
            return await asyncio.to_thread(
                self.scraper.get_fortune,
                last_name, name, "m", True
            )

    # å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¸¦åˆ—å®Ÿè¡Œ
    tasks = [process_pattern(p) for p in patterns]
    results = await asyncio.gather(*tasks)
```

**é€²æ—ç®¡ç†**
```python
# ã‚°ãƒ­ãƒ¼ãƒãƒ«é€²æ—è¾æ›¸
analysis_progress = {
    "queue_id": {
        "progress": 45.5,     # å®Œäº†ç‡%
        "status": "running",  # running/complete/error
        "pattern": [8, 13],   # ç¾åœ¨å‡¦ç†ä¸­ãƒ‘ã‚¿ãƒ¼ãƒ³
        "results": {...}      # å®Œäº†æ™‚ã®ã¿
    }
}
```

### åå‰å€™è£œç”Ÿæˆæ©Ÿèƒ½
**å®Ÿè£…ã‚¯ãƒ©ã‚¹**: `NameGenerator`
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/name_candidates`

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**
```sql
CREATE TABLE names (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,           -- æ¼¢å­—åå‰
    yomi TEXT,                    -- èª­ã¿ä»®å
    chars INTEGER NOT NULL,       -- æ–‡å­—æ•°
    strokes_1 INTEGER NOT NULL,   -- 1æ–‡å­—ç›®ç”»æ•°
    strokes_2 INTEGER,            -- 2æ–‡å­—ç›®ç”»æ•°
    strokes_3 INTEGER,            -- 3æ–‡å­—ç›®ç”»æ•°
    total_strokes INTEGER NOT NULL, -- ç·ç”»æ•°
    gender TEXT NOT NULL,         -- æ€§åˆ¥
    source_url TEXT,              -- å–å¾—å…ƒURL
    scraped_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_search ON names(chars, strokes_1, strokes_2, strokes_3, gender);
```

**å‹•çš„ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ï¼‰**
```python
def name_candidates_api():
    candidates = get_name_candidates(...)
    if not candidates:
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
        job_id = start_background_scraping(...)
        return {"scraping": True, "job_id": job_id}, 202
    return {"candidates": candidates, "count": len(candidates)}
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä»•æ§˜è©³ç´°

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ
**Pydanticãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹å‹å®‰å…¨æ€§**
```python
class ErrorResponse(BaseModel):
    error: str
    timestamp: datetime = Field(default_factory=datetime.now)
    request_id: Optional[str] = None

class FortuneResponse(BaseModel):
    enamae: Dict[str, str]
    namaeuranai: Dict[str, str]
    total_score: float = Field(ge=0, le=100)
    processing_time: float
```

**æ§‹é€ åŒ–ãƒ­ã‚°è¨­è¨ˆ**
```python
import structlog

logger = structlog.get_logger(__name__)

# ä½¿ç”¨ä¾‹
logger.info("fortune_analysis_completed",
           last_name=last_name,
           first_name=first_name,
           total_score=score,
           processing_time=elapsed_time)
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```python
# åˆ†æçµæœã®æ°¸ç¶šåŒ–
def save_analysis_cache(last_name: str, char_count: int, results: dict):
    filename = f"static/results_{last_name}_{char_count}å­—.json"
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)

# åå‰å€™è£œã®DBä¿å­˜
def cache_name_candidates(candidates: List[Dict]):
    conn = sqlite3.connect(DB_PATH)
    for candidate in candidates:
        conn.execute("""
            INSERT OR IGNORE INTO names
            (name, yomi, chars, strokes_1, strokes_2, strokes_3,
             total_strokes, gender, source_url)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (candidate['name'], candidate['yomi'], ...))
    conn.commit()
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¨ãƒ©ãƒ¼å‡¦ç†

### å…¥åŠ›æ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼
**ãƒ¬ãƒ™ãƒ«1: Pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**
```python
class FortuneRequest(BaseModel):
    last_name: str = Field(..., min_length=1, max_length=10,
                          regex=r'^[ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾¯ã€…]+$')
    first_name: str = Field(..., min_length=1, max_length=10,
                           regex=r'^[ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾¯ã€…]+$')
    gender: Literal['m', 'f']
```

**ãƒ¬ãƒ™ãƒ«2: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼**
```python
def validate_stroke_pattern(chars: int, strokes: List[int]) -> bool:
    if len(strokes) != chars:
        return False
    if any(s < 1 or s > 30 for s in strokes):
        return False
    return True
```

### ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
| ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— | HTTPã‚³ãƒ¼ãƒ‰ | å¯¾å¿œç­– |
|--------------|------------|--------|
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | 400 | è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å¤–éƒ¨ã‚µã‚¤ãƒˆéšœå®³ | 503 | ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | 504 | éƒ¨åˆ†çµæœè¿”å´ |
| ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ | 500 | ãƒ­ã‚°å‡ºåŠ›ãƒ»é€šçŸ¥ |

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµ±ä¸€**
```python
@app.errorhandler(ValidationError)
def handle_validation_error(e):
    error_response = ErrorResponse(
        error=f"å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™: {str(e)}",
        request_id=request.headers.get('X-Request-ID')
    )
    return jsonify(error_response.model_dump()), 400
```

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»è² è·åˆ¶å¾¡
```python
# ã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹åŒæ™‚æ¥ç¶šæ•°åˆ¶é™
scraping_semaphore = asyncio.Semaphore(4)

# å¤–éƒ¨ã‚µã‚¤ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”åˆ¶å¾¡
async def rate_limited_request(url: str, delay: float = 0.5):
    async with scraping_semaphore:
        await asyncio.sleep(delay)
        return await make_request(url)
```

## ğŸŒ REST APIä»•æ§˜

### çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆ
**æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "success": true,
  "data": { /* å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ */ },
  "timestamp": "2024-03-20T10:00:00+09:00",
  "processing_time": 0.125
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™",
    "details": ["å§“ã¯å¿…é ˆé …ç›®ã§ã™"]
  },
  "timestamp": "2024-03-20T10:00:00+09:00"
}
```

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

#### 1. å§“ååˆ¤æ–­API
```http
POST /api/v1/analyze
Content-Type: application/json

{
  "last_name": "å±±ç”°",
  "first_name": "å¤ªéƒ",
  "gender": "m"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ200 OKï¼‰**
```json
{
  "success": true,
  "data": {
    "enamae": {
      "å¤©æ ¼": "å¤§å‰", "äººæ ¼": "å‰", "åœ°æ ¼": "å¤§å‰",
      "å¤–æ ¼": "å‡¶", "ç·æ ¼": "å‰", "ä¸‰æ‰é…ç½®": "å‰"
    },
    "namaeuranai": {
      "å¤©æ ¼": "å¤§å¤§å‰", "äººæ ¼": "å‰", "åœ°æ ¼": "å¤§å‰",
      "å¤–æ ¼": "å‡¶", "ç·æ ¼": "å‰", "ä»•äº‹é‹": "å¤§å‰", "å®¶åº­é‹": "å‰"
    },
    "scores": {
      "enamae_score": 86.7,
      "namaeuranai_score": 88.6,
      "total_score": 87.6
    }
  },
  "processing_time": 2.34
}
```

#### 2. ç”»æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æAPI
```http
POST /api/v1/analyze_strokes
Content-Type: application/json

{
  "last_name": "ç”°ä¸­",
  "char_count": 2
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ202 Acceptedï¼‰**
```json
{
  "success": true,
  "data": {
    "queue_id": "ç”°ä¸­_2_20240320100000",
    "estimated_time": 300,
    "total_patterns": 400
  }
}
```

#### 3. åˆ†æé€²æ—ç¢ºèªAPI
```http
GET /api/v1/analyze_progress/{queue_id}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ200 OKï¼‰**
```json
{
  "success": true,
  "data": {
    "progress": 45.5,
    "status": "running",
    "current_pattern": [8, 13],
    "completed_patterns": 182,
    "total_patterns": 400,
    "estimated_remaining": 185
  }
}
```

#### 4. åå‰å€™è£œç”ŸæˆAPI
```http
GET /api/v1/name_candidates?chars=2&strokes1=8&strokes2=13&gender=male
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ200 OKï¼‰**
```json
{
  "success": true,
  "data": {
    "candidates": [
      {
        "name": "ä½³æ¨¹",
        "yomi": "ã‹ãšã",
        "gender": "male",
        "total_strokes": 21
      },
      {
        "name": "è‹±è³‡",
        "yomi": "ãˆã„ã—",
        "gender": "male",
        "total_strokes": 21
      }
    ],
    "count": 47,
    "search_criteria": {
      "chars": 2,
      "strokes": [8, 13],
      "gender": "male"
    }
  }
}
```

#### 5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯API
```http
GET /healthz
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆ200 OKï¼‰**
```json
{
  "status": "healthy",
  "timestamp": "2024-03-20T10:00:00+09:00",
  "version": "1.0.0",
  "dependencies": {
    "database": "connected",
    "external_sites": "reachable"
  }
}
```

### APIèªè¨¼ãƒ»åˆ¶é™ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
```http
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ä¾‹
Authorization: Bearer {api_token}
X-Request-ID: {unique_request_id}
X-Rate-Limit: 100
```
